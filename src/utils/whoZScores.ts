// WHO z-score reference data
export const whoZScores = {
  boys: {
    height: {
      0: [44.2, 46.1, 48.0, 49.9, 51.8, 53.7, 55.6],
      2: [52.4, 54.4, 56.4, 58.4, 60.4, 62.4, 64.4],
      4: [58.0, 60.0, 62.0, 64.0, 66.0, 68.0, 70.0],
      6: [62.4, 64.4, 66.4, 68.4, 70.4, 72.4, 74.4],
      8: [65.9, 67.9, 69.9, 71.9, 73.9, 75.9, 77.9],
      10: [69.0, 71.0, 73.0, 75.0, 77.0, 79.0, 81.0],
      12: [71.9, 73.9, 75.9, 77.9, 79.9, 81.9, 83.9]
    },
    weight: {
      0: [2.1, 2.5, 2.9, 3.3, 3.7, 4.1, 4.5],
      2: [3.4, 3.9, 4.4, 4.9, 5.4, 5.9, 6.4],
      4: [4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5],
      6: [5.3, 5.9, 6.5, 7.1, 7.7, 8.3, 8.9],
      8: [6.0, 6.6, 7.2, 7.8, 8.4, 9.0, 9.6],
      10: [6.6, 7.2, 7.8, 8.4, 9.0, 9.6, 10.2],
      12: [7.1, 7.7, 8.3, 8.9, 9.5, 10.1, 10.7]
    },
    head: {
      0: [31.9, 33.2, 34.5, 35.8, 37.1, 38.4, 39.7],
      2: [35.6, 36.9, 38.2, 39.5, 40.8, 42.1, 43.4],
      4: [38.0, 39.3, 40.6, 41.9, 43.2, 44.5, 45.8],
      6: [39.7, 41.0, 42.3, 43.6, 44.9, 46.2, 47.5],
      8: [41.0, 42.3, 43.6, 44.9, 46.2, 47.5, 48.8],
      10: [42.0, 43.3, 44.6, 45.9, 47.2, 48.5, 49.8],
      12: [42.9, 44.2, 45.5, 46.8, 48.1, 49.4, 50.7]
    }
  },
  girls: {
    height: {
      0: [43.6, 45.4, 47.2, 49.1, 51.0, 52.9, 54.7],
      2: [51.0, 52.9, 54.7, 56.6, 58.5, 60.4, 62.2],
      4: [56.7, 58.6, 60.4, 62.3, 64.2, 66.1, 67.9],
      6: [61.2, 63.0, 64.8, 66.7, 68.6, 70.5, 72.3],
      8: [64.8, 66.6, 68.4, 70.3, 72.2, 74.1, 75.9],
      10: [67.8, 69.6, 71.4, 73.3, 75.2, 77.1, 78.9],
      12: [70.6, 72.4, 74.2, 76.1, 78.0, 79.9, 81.7]
    },
    weight: {
      0: [2.0, 2.4, 2.8, 3.2, 3.6, 4.0, 4.4],
      2: [3.2, 3.7, 4.2, 4.7, 5.2, 5.7, 6.2],
      4: [4.2, 4.8, 5.4, 6.0, 6.6, 7.2, 7.8],
      6: [5.1, 5.7, 6.3, 6.9, 7.5, 8.1, 8.7],
      8: [5.8, 6.4, 7.0, 7.6, 8.2, 8.8, 9.4],
      10: [6.4, 7.0, 7.6, 8.2, 8.8, 9.4, 10.0],
      12: [6.9, 7.5, 8.1, 8.7, 9.3, 9.9, 10.5]
    },
    head: {
      0: [31.5, 32.7, 33.9, 35.1, 36.3, 37.5, 38.7],
      2: [35.1, 36.3, 37.5, 38.7, 39.9, 41.1, 42.3],
      4: [37.5, 38.7, 39.9, 41.1, 42.3, 43.5, 44.7],
      6: [39.1, 40.3, 41.5, 42.7, 43.9, 45.1, 46.3],
      8: [40.4, 41.6, 42.8, 44.0, 45.2, 46.4, 47.6],
      10: [41.5, 42.7, 43.9, 45.1, 46.3, 47.5, 48.7],
      12: [42.4, 43.6, 44.8, 46.0, 47.2, 48.4, 49.6]
    }
  }
};

export const getZScore = (
  measurement: number,
  age: number,
  type: 'height' | 'weight' | 'head',
  gender: 'boys' | 'girls'
): number => {
  if (!whoZScores[gender]?.[type]) {
    console.error(`Invalid gender or measurement type: ${gender}, ${type}`);
    return 0;
  }

  // Find the closest age in the reference data
  const ages = Object.keys(whoZScores[gender][type]).map(Number);
  const closestAge = ages.reduce((prev, curr) => {
    return Math.abs(curr - age) < Math.abs(prev - age) ? curr : prev;
  });

  const zScores = whoZScores[gender][type][closestAge];
  
  // Find where the measurement falls in the z-score distribution
  for (let i = 0; i < zScores.length - 1; i++) {
    if (measurement <= zScores[i + 1]) {
      const interpolation = (measurement - zScores[i]) / (zScores[i + 1] - zScores[i]);
      return -3 + i + interpolation;
    }
  }
  
  return measurement < zScores[0] ? -3 : 3;
};